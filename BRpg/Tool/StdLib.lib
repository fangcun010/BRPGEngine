'[FUNC]
'===================================================
' 数学函数的定义，通过内嵌汇编实现数学运算
FUNCTION SIN!(X!)
	DIM SHARED STATIC_FLOAT!
	
	STATIC_FLOAT! = X!
	VASM("LD int r3,[VFLO_STATIC_FLOAT]")
	VASM("IN [VFLO_STATIC_FLOAT],16")
	SIN! = STATIC_FLOAT!
END FUNCTION

FUNCTION COS!(X!)
	DIM SHARED STATIC_FLOAT!
	
	STATIC_FLOAT! = X!
	VASM("LD int r3,[VFLO_STATIC_FLOAT]")
	VASM("IN [VFLO_STATIC_FLOAT],17")
	COS! = STATIC_FLOAT!
END FUNCTION

FUNCTION TAN!(X!)
	DIM SHARED STATIC_FLOAT!
	
	STATIC_FLOAT! = X!
	VASM("LD int r3,[VFLO_STATIC_FLOAT]")
	VASM("IN [VFLO_STATIC_FLOAT],18")
	TAN! = STATIC_FLOAT!
END FUNCTION

FUNCTION SQR!(X!)
	DIM SHARED STATIC_FLOAT!
	
	STATIC_FLOAT! = X!
	VASM("LD int r3,[VFLO_STATIC_FLOAT]")
	VASM("IN [VFLO_STATIC_FLOAT],19")
	SQR! = STATIC_FLOAT!
END FUNCTION

FUNCTION ABS!(X!)
	DIM SHARED STATIC_FLOAT!
	
	STATIC_FLOAT! = X!
	VASM("LD int r3,[VFLO_STATIC_FLOAT]")
	VASM("IN [VFLO_STATIC_FLOAT],21")
	ABS! = STATIC_FLOAT!
END FUNCTION

FUNCTION ABS(X)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")
	VASM("IN  r3,20")
	VASM("LD int [rb],r3")
END FUNCTION

FUNCTION LOCATE(LINE,ROW)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,16")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 36,0")
	VASM("LD int [rb],0")
END FUNCTION

'===================================================
' 触摸屏支持函数
FUNCTION GETPENPOSX(param)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("CAL int SUB [r0],-2147483648")
	VASM("LD int r0,[r0]")
	VASM("CAL int MOD r0,65536")
	VASM("LD int [rb],r0")
END FUNCTION

FUNCTION GETPENPOSY(param)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r1,rb")
	VASM("CAL int ADD r1,-4")
	VASM("CAL int SUB [r0],-2147483648")
	VASM("LD int [r1],[r0]")
	VASM("CAL int MOD [r1],65536")
	VASM("LD int r0,[r0]")
	VASM("CAL int SUB r0,[r1]")
	VASM("LD int [r1],r0")
	VASM("LD int r1,[r1]")
	VASM("CAL int DIV r1,65536")
	VASM("LD int [rb],r1")
END FUNCTION

'===================================================
' 字符串函数支持
FUNCTION LEN(X$)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")
	VASM("IN r3,39")
	VASM("LD int [rb],r3")
END FUNCTION

FUNCTION STR$(X)
	DIM SHARED STATIC_STR$
	
	STATIC_STR$ = "                                "
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("LD int r2,0")
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r1,[r0]")
	VASM("IN r1,32")
	STR$ = STATIC_STR$
END FUNCTION

FUNCTION VAL(X$)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")
	VASM("IN r3,33")
	VASM("LD int [rb],r3")
END FUNCTION

FUNCTION CHR$(X)
	DIM SHARED STATIC_STR$
	
	STATIC_STR$ = " "
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("LD int r2,0")
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r1,[r0]")
	VASM("IN r1,13")
	CHR$ = STATIC_STR$
END FUNCTION

FUNCTION ASC(X$)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")
	VASM("IN r3,34")
	VASM("LD int [rb],r3")
END FUNCTION

FUNCTION LEFT$(X$,N)
	DIM SHARED STATIC_STR$

	STATIC_STR$ = X$
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r2,[r0]")
	VASM("IN r1,35")
	LEFT$ = STATIC_STR$
END FUNCTION

FUNCTION RIGHT$(X$,N)
	DIM SHARED STATIC_STR$

	STATIC_STR$ = X$
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,16")
	VASM("LD int r2,[r0]")	
	VASM("CAL int SUB r0,4")
	VASM("LD int r1,[r0]")
	VASM("IN r1,36")
	RIGHT$ = STATIC_STR$
END FUNCTION

FUNCTION MID$(X$,S,N)
	DIM SHARED STATIC_STR$

	STATIC_STR$ = X$
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,20")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r1,[r0]")
	VASM("PUSH r1")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r1,[r0]")
	VASM("LD int r0,r1")
	VASM("POP r1")
	VASM("IN r1,37")
	MID$ = STATIC_STR$
END FUNCTION

FUNCTION INSTR(N,S$,B$)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,20")
	VASM("LD int r1,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("IN r3,38")
	VASM("LD int [rb],r3")
END FUNCTION

FUNCTION INKEY$()
	DIM SHARED STATIC_STR$
	
	STATIC_STR$ = "  "
	VASM("LD int r3,[VSTR_STATIC_STR]")
	VASM("OUT 45,0")
	INKEY$ = STATIC_STR$
END FUNCTION


'===================================================
' 图形函数支持
FUNCTION SETPEN(PAGE,STYLE,WID,COLOR)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT COLOR
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 64,0")
END FUNCTION

FUNCTION SETBRUSH(PAGE,STYLE)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,16")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 65,0")
END FUNCTION

FUNCTION MOVETO(PAGE,X,Y)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,20")
	VASM("LD int r1,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 66,0")
END FUNCTION

FUNCTION LINETO(PAGE,X,Y)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,20")
	VASM("LD int r1,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 67,0")
END FUNCTION

FUNCTION RECTANGLE(PAGE,LEFT,TOP,RIGHT,BOTTOM)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT BOTTOM
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 68,0")
END FUNCTION

FUNCTION CIRCLE(PAGE,CX,CY,CR)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT CR
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 69,0")
END FUNCTION

'===================================================
' 游戏功能，支持

FUNCTION SETLCD(WIDTH,HEIGHT)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,16")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 16,0")
	VASM("LD int [rb],0")
END FUNCTION

FUNCTION CREATEPAGE()
	VASM("OUT 17,0")
	VASM("LD int [rb],r3")		'设置返回值(DELETEPAGE = r3)
END FUNCTION

FUNCTION DELETEPAGE(PAGE)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = PAGE)
	VASM("OUT 18,0")
	VASM("LD int [rb],r3")		'设置返回值(DELETEPAGE = r3)
END FUNCTION

FUNCTION LOADRES(FILE$,ID)
	DIM SHARED STATIC_INT1,STATIC_INT2
	
	LOADPTR STATIC_INT1 FILE$
	STATIC_INT2 = ID
	VASM("LD int r2,[VINT_STATIC_INT1]")
	VASM("LD int r3,[r2]")
	VASM("LD int r2,[VINT_STATIC_INT2]")
	VASM("OUT 19,0")
	VASM("LD int [VINT_STATIC_INT1],r3")
	LOADRES = STATIC_INT1
END FUNCTION

FUNCTION FREERES(ID)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = ID)
	VASM("OUT 26,0")
END FUNCTION

FUNCTION SHOWPIC(PAGE,PIC,DX,DY,W,H,X,Y,MODE)
	DIM SHARED STATIC_INT

	LOADPTR STATIC_INT MODE
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 20,0")
END FUNCTION

FUNCTION FLIPPAGE(PAGE)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = PAGE)
	VASM("OUT 21,0")
END FUNCTION

FUNCTION BITBLTPAGE(DEST,SRC)
	DIM SHARED STATIC_INT1,STATIC_INT2

	STATIC_INT1 = DEST
	STATIC_INT2 = SRC
	VASM("LD int r2,[VINT_STATIC_INT1]")
	VASM("LD int r3,[VINT_STATIC_INT2]")
	VASM("OUT 22,0")
END FUNCTION

FUNCTION STRETCHBLTPAGE(X,Y,DEST,SRC)
	DIM SHARED STATIC_INT

	LOADPTR STATIC_INT SRC
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 43,0")
END FUNCTION

FUNCTION STRETCHBLTPAGEEX(X,Y,WID,HGT,CX,CY,DEST,SRC)
	DIM SHARED STATIC_INT

	LOADPTR STATIC_INT SRC
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 80,0")
END FUNCTION

FUNCTION FILLPAGE(PAGE,X,Y,WID,HGT,COLOR)
	DIM SHARED STATIC_INT

	LOADPTR STATIC_INT COLOR
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 23,0")
END FUNCTION

FUNCTION PIXEL(PAGE,X,Y,COLOR)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT COLOR
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 24,0")
END FUNCTION

FUNCTION READPIXEL(PAGE,X,Y)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT Y
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 25,0")
	VASM("LD int [VINT_STATIC_INT],r3")
	READPIXEL = STATIC_INT
END FUNCTION

FUNCTION COLOR(FRONT,BACK,FRAME)
	DIM SHARED STATIC_INT
	
	LOADPTR STATIC_INT FRAME
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 37,0")
END FUNCTION

FUNCTION FONT(F)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = F)
	VASM("OUT 38,0")
END FUNCTION

FUNCTION SETBKMODE(mode)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = mode)
	VASM("OUT 44,0")
END FUNCTION

FUNCTION RANDOMIZE(SEED)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = SEED)
	VASM("OUT 32,0")
END FUNCTION

FUNCTION RND(RANGE)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = RANGE)
	VASM("OUT 33,0")
	VASM("LD int [rb],r3")		'设置返回值(DELETEPAGE = r3)
END FUNCTION

FUNCTION KEYPRESS(KEY)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = KEY)
	VASM("OUT 34,0")
	VASM("LD int [rb],r3")		'设置返回值(KEYPRESS = r3)
END FUNCTION

FUNCTION WAITKEY()
	VASM("OUT 39,0")
	VASM("LD int [rb],r3")		'设置返回值(KEYPRESS = r3)
END FUNCTION

FUNCTION INKEY()
	VASM("OUT 46,0")
	VASM("LD int [rb],r3")		'设置返回值(KEYPRESS = r3)
END FUNCTION


FUNCTION GETPICWID(PIC)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = PIC)
	VASM("OUT 40,0")
	VASM("LD int [rb],r3")		'设置返回值(GETPICWID = r3)
END FUNCTION

FUNCTION GETPICHGT(PIC)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = PIC)
	VASM("OUT 41,0")
	VASM("LD int [rb],r3")		'设置返回值(GETPICHGT = r3)
END FUNCTION

FUNCTION PIXLOCATE(LINE,ROW)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,16")
	VASM("LD int r2,[r0]")
	VASM("CAL int ADD r0,-4")
	VASM("LD int r3,[r0]")
	VASM("OUT 42,0")
	VASM("LD int [rb],0")
END FUNCTION

'===================================================
' 特殊功能
FUNCTION GETTICK()
	DIM SHARED STATIC_INT
	
	VASM("IN [VINT_STATIC_INT],15")
	GETTICK = STATIC_INT
END FUNCTION

FUNCTION MSDELAY(MSEC)
	VASM("LD int r0,rb")
	VASM("CAL int ADD r0,12")
	VASM("LD int r3,[r0]")		'设置参数(r3 = MSEC)
	VASM("OUT 27,0")
END FUNCTION

FUNCTION PEEK(ADDRESS)
	DIM SHARED STATIC_INT
	
	STATIC_INT = ADDRESS
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("IN r3,23")
	VASM("LD int [VINT_STATIC_INT],r3")
	PEEK = STATIC_INT
END FUNCTION

FUNCTION GETENV!()
	DIM SHARED STATIC_FLOAT!
	
	VASM("IN [VFLO_STATIC_FLOAT],25")
	GETENV! = STATIC_FLOAT!
END FUNCTION

FUNCTION VMTEST()
	VASM("OUT 255,0")
END FUNCTION

'===================================================
' 文件支持
FUNCTION EOF(FILE)
	DIM SHARED STATIC_INT
	
	STATIC_INT = FILE
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 52,0")
	VASM("LD int [VINT_STATIC_INT],r3")
	EOF = STATIC_INT
END FUNCTION

FUNCTION LOF(FILE)
	DIM SHARED STATIC_INT
	
	STATIC_INT = FILE
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 53,0")
	VASM("LD int [VINT_STATIC_INT],r3")
	LOF = STATIC_INT
END FUNCTION

FUNCTION LOC(FILE)
	DIM SHARED STATIC_INT
	
	STATIC_INT = FILE
	VASM("LD int r3,[VINT_STATIC_INT]")
	VASM("OUT 54,0")
	VASM("LD int [VINT_STATIC_INT],r3")
	LOC = STATIC_INT
END FUNCTION
'[END FUNC]

'[COMMON]
Const KEY_UP = 38
Const KEY_DOWN = 40
Const KEY_LEFT = 37
Const KEY_RIGHT = 39
Const KEY_SPACE = 32
Const KEY_ESCAPE = 27
Const KEY_ENTER = 13

Const ENV_SIM = 0
Const ENV_9288 = 9288
Const ENV_9188 = 9188
Const ENV_9288T = 9287	'9288-1
Const ENV_9288S = 9286	'9288-2
Const ENV_9388 = 9388

Const FONT_12SONG = 0
Const FONT_12KAI = 1
Const FONT_12HEI = 2
Const FONT_16SONG = 3
Const FONT_16KAI = 4
Const FONT_16HEI = 5
Const FONT_24SONG = 6
Const FONT_24KAI = 7
Const FONT_24HEI = 8

Const TRANSPARENT = 1
Const OPAQUE = 2

Const PEN_SOLID =	0
Const PEN_DASH	 =	1

Const BRUSH_SOLID = 0

'[END COMMON]
